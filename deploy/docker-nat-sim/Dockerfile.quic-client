# Dockerfile for QUIC Test Client (Agent Simulator)
# Multi-stage build for optimized image size

# =============================================================================
# Build Stage
# =============================================================================
FROM rust:1.83-slim-bookworm AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    cmake \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy QUIC test client source (no workspace, standalone crate)
COPY tests/e2e/fixtures/quic-client ./quic-client

# Build the QUIC test client in release mode
WORKDIR /build/quic-client
RUN cargo build --release

# =============================================================================
# Runtime Stage
# =============================================================================
FROM debian:bookworm-slim

# Install runtime dependencies and network tools for debugging
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    iproute2 \
    iputils-ping \
    tcpdump \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN useradd -r -s /bin/false ztna

# Copy binary from builder
COPY --from=builder /build/quic-client/target/release/quic-test-client /usr/local/bin/

# Copy entrypoint script
COPY deploy/docker-nat-sim/entrypoint-client.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Container runs as root to set up routes (test container, security less critical)

# Default environment variables
ENV RUST_LOG=info
ENV ZTNA_SERVER=172.20.0.10:4433
ENV ZTNA_SERVICE_ID=test-service

# No ports to expose - client initiates outbound connections

# Entrypoint sets up routing then runs the client
ENTRYPOINT ["/entrypoint.sh"]

# Default: connect to intermediate server and register as agent
CMD ["--server", "172.20.0.10:4433", \
     "--service", "test-service", \
     "--send-udp", "Hello from NAT!", \
     "--dst", "172.22.0.20:9999", \
     "--wait", "5000"]
